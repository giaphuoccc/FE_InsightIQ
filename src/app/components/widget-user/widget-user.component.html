<div class="chatbot-toggle-btn" (click)="toggleChatbox()" *ngIf="!showChatbox">
  💬
</div>

<div
  class="chatbot-box"
  [ngClass]="{ expanded: isChatting }"
  *ngIf="showChatbox"
>
  <div class="header-buttons">
    <button
      *ngIf="isChatting"
      class="clear-btn"
      (click)="clearChat()"
      title="Xóa đoạn chat"
    >
      <img
        src="assets/icon/user/clear-chat-icon.png"
        alt="Clear Chat"
        class="header-icon"
      />
    </button>
    <button class="close-btn" (click)="toggleChatbox()" title="Đóng chat">
      <img
        src="assets/icon/user/close-chat-icon.png"
        alt="Đóng chat"
        class="header-icon"
      />
    </button>
  </div>

  <ng-container *ngIf="!isChatting">
    <img src="assets/icon-chatbot.png" class="chat-icon" alt="Chatbot Icon" />
    <h3 class="title">AI Assistant</h3>
    <div>
      <div class="input-group">
        <input
          type="text"
          placeholder="Please enter your phone number"
          class="chat-input"
        />
      </div>
      <div class="input-group">
        <input
          type="text"
          placeholder="Please enter your name"
          class="chat-input"
        />
      </div>
      <button class="start-btn" (click)="startChat()">START CHAT</button>
    </div>
  </ng-container>

  <div *ngIf="isChatting" class="chat-container">
    <div class="chat-box" #chatBox>
      <div
        *ngFor="let msg of messages"
        class="message-wrapper"
        [ngClass]="{
          'user-message-wrapper': msg?.sender === 'user',
          'bot-message-wrapper': msg?.sender === 'bot'
        }"
      >
        <div
          class="message"
          [ngClass]="{
            'user-message': msg?.sender === 'user',
            'bot-message': msg?.sender === 'bot'
          }"
        >
          <ng-container [ngSwitch]="msg?.type">
            <app-product-info
              *ngSwitchCase="'productInfo'"
              [productData]="msg?.content"
            ></app-product-info>
            <app-product-comparison
              *ngSwitchCase="'productComparison'"
              [data]="msg?.content"
            ></app-product-comparison>
            <product-promotion
              *ngSwitchCase="'productPromotion'"
              [promotionData]="msg?.content"
            ></product-promotion>

            <p
              *ngSwitchDefault
              [innerHTML]="renderMarkdownBold(msg?.content)"
            ></p>
          </ng-container>

          <span class="timestamp" *ngIf="msg?.timestamp">
            {{ msg.timestamp | date : "shortTime" }}
          </span>

          <div *ngIf="msg?.sender === 'bot'" class="feedback-buttons">
            <i
              class="fas fa-thumbs-up"
              [ngClass]="{ 'active-like': msg?.liked }"
              (click)="toggleLike(msg)"
              title="Like response"
            >
            </i>
            <i
              class="fas fa-thumbs-down"
              [ngClass]="{ 'active-dislike': msg?.disliked }"
              (click)="toggleDislike(msg)"
              title="Dislike response"
            >
            </i>
          </div>
        </div>
      </div>

      <div
        *ngIf="isBotResponding"
        class="bot-message-wrapper loading-indicator"
      >
        <div class="message bot-message typing-indicator">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </div>

    <div class="message-input">
      <div class="input-wrapper">
        <textarea
          class="chat-input auto-expand"
          placeholder="Type a message..."
          rows="1"
          [(ngModel)]="messageText"
          (input)="autoExpand($event)"
          (keydown)="handleKeyDown($event)"
          aria-label="Chat message input"
        >
        </textarea>
      </div>
      <button
        *ngIf="!isBotResponding"
        class="send-btn"
        (click)="onSendMessage()"
        [disabled]="!messageText.trim()"
        aria-label="Send message"
        title="Send message"
      >
        <img src="assets/send-icon.png" class="send-icon" alt="Send" />
      </button>
      <button
        *ngIf="isBotResponding"
        class="stop-btn"
        (click)="stopBotResponse()"
        aria-label="Stop generating response"
        title="Stop generating response"
      >
        <img src="assets/icon/user/stop-icon.png" alt="Stop generating" />
      </button>
    </div>
  </div>
</div>
